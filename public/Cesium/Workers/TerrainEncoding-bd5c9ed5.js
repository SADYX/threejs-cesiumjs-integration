define(["exports","./Transforms-fce95115","./Matrix3-81054f0f","./defaultValue-f6d5e6da","./Matrix2-413c4048","./AttributeCompression-48e336db","./ComponentDatatype-ab629b88","./Math-2ce22ee9"],function(e,t,i,a,r,o,n,s){"use strict";function l(e,t){this._ellipsoid=e,this._cameraPosition=new i.Cartesian3,this._cameraPositionInScaledSpace=new i.Cartesian3,this._distanceToLimbInScaledSpaceSquared=0,a.defined(t)&&(this.cameraPosition=t)}Object.defineProperties(l.prototype,{ellipsoid:{get:function(){return this._ellipsoid}},cameraPosition:{get:function(){return this._cameraPosition},set:function(e){let t=this._ellipsoid.transformPositionToScaledSpace(e,this._cameraPositionInScaledSpace),a=i.Cartesian3.magnitudeSquared(t)-1;i.Cartesian3.clone(e,this._cameraPosition),this._cameraPositionInScaledSpace=t,this._distanceToLimbInScaledSpaceSquared=a}}});let c=new i.Cartesian3;l.prototype.isPointVisible=function(e){return C(this._ellipsoid.transformPositionToScaledSpace(e,c),this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)},l.prototype.isScaledSpacePointVisible=function(e){return C(e,this._cameraPositionInScaledSpace,this._distanceToLimbInScaledSpaceSquared)};let d=new i.Cartesian3;l.prototype.isScaledSpacePointVisiblePossiblyUnderEllipsoid=function(e,t){let i,r;let o=this._ellipsoid;return a.defined(t)&&t<0&&o.minimumRadius>-t?((r=d).x=this._cameraPosition.x/(o.radii.x+t),r.y=this._cameraPosition.y/(o.radii.y+t),r.z=this._cameraPosition.z/(o.radii.z+t),i=r.x*r.x+r.y*r.y+r.z*r.z-1):(r=this._cameraPositionInScaledSpace,i=this._distanceToLimbInScaledSpaceSquared),C(e,r,i)},l.prototype.computeHorizonCullingPoint=function(e,t,i){return p(this._ellipsoid,e,t,i)};let u=i.Ellipsoid.clone(i.Ellipsoid.UNIT_SPHERE);l.prototype.computeHorizonCullingPointPossiblyUnderEllipsoid=function(e,t,i,a){return p(f(this._ellipsoid,i,u),e,t,a)},l.prototype.computeHorizonCullingPointFromVertices=function(e,t,i,a,r){return S(this._ellipsoid,e,t,i,a,r)},l.prototype.computeHorizonCullingPointFromVerticesPossiblyUnderEllipsoid=function(e,t,i,a,r,o){return S(f(this._ellipsoid,r,u),e,t,i,a,o)};let m=[];l.prototype.computeHorizonCullingPointFromRectangle=function(e,a,o){let n=r.Rectangle.subsample(e,a,0,m),s=t.BoundingSphere.fromPoints(n);if(!(i.Cartesian3.magnitude(s.center)<.1*a.minimumRadius))return this.computeHorizonCullingPoint(s.center,n,o)};let h=new i.Cartesian3;function f(e,t,r){if(a.defined(t)&&t<0&&e.minimumRadius>-t){let a=i.Cartesian3.fromElements(e.radii.x+t,e.radii.y+t,e.radii.z+t,h);e=i.Ellipsoid.fromCartesian3(a,r)}return e}function p(e,t,r,o){a.defined(o)||(o=new i.Cartesian3);let n=b(e,t),s=0;for(let t=0,i=r.length;t<i;++t){let i=N(e,r[t],n);if(i<0)return;s=Math.max(s,i)}return M(n,s,o)}let x=new i.Cartesian3;function S(e,t,r,o,n,s){a.defined(s)||(s=new i.Cartesian3),o=a.defaultValue(o,3),n=a.defaultValue(n,i.Cartesian3.ZERO);let l=b(e,t),c=0;for(let t=0,i=r.length;t<i;t+=o){x.x=r[t]+n.x,x.y=r[t+1]+n.y,x.z=r[t+2]+n.z;let i=N(e,x,l);if(i<0)return;c=Math.max(c,i)}return M(l,c,s)}function C(e,t,a){let r=i.Cartesian3.subtract(e,t,c),o=-i.Cartesian3.dot(r,t);return!(a<0?o>0:o>a&&o*o/i.Cartesian3.magnitudeSquared(r)>a)}let g=new i.Cartesian3,y=new i.Cartesian3;function N(e,t,a){let r=e.transformPositionToScaledSpace(t,g),o=i.Cartesian3.magnitudeSquared(r),n=Math.sqrt(o),s=i.Cartesian3.divideByScalar(r,n,y);o=Math.max(1,o),n=Math.max(1,n);let l=1/n;return 1/(i.Cartesian3.dot(s,a)*l-i.Cartesian3.magnitude(i.Cartesian3.cross(s,a,s))*(Math.sqrt(o-1)*l))}function M(e,t,a){if(!(t<=0||t===1/0||t!=t))return i.Cartesian3.multiplyByScalar(e,t,a)}let T=new i.Cartesian3;function b(e,t){return i.Cartesian3.equals(t,i.Cartesian3.ZERO)?t:(e.transformPositionToScaledSpace(t,T),i.Cartesian3.normalize(T,T))}let P={getHeight:function(e,t,i){return(e-i)*t+i}},z=new i.Cartesian3;P.getPosition=function(e,t,a,r,o){let n=t.cartesianToCartographic(e,z),s=P.getHeight(n.height,a,r);return i.Cartesian3.fromRadians(n.longitude,n.latitude,s,t,o)};var _=Object.freeze({NONE:0,BITS12:1});let E=new i.Cartesian3,H=new i.Cartesian3,w=new r.Cartesian2,A=new r.Matrix4,I=new r.Matrix4;function V(e,t,o,n,s,l,c,d,u,m){let h,f,p=_.NONE;if(a.defined(t)&&a.defined(o)&&a.defined(n)&&a.defined(s)){let e=t.minimum,a=t.maximum,l=i.Cartesian3.subtract(a,e,H);p=4095>Math.max(i.Cartesian3.maximumComponent(l),n-o)?_.BITS12:_.NONE,h=r.Matrix4.inverseTransformation(s,new r.Matrix4);let c=i.Cartesian3.negate(e,E);r.Matrix4.multiply(r.Matrix4.fromTranslation(c,A),h,h);let d=E;d.x=1/l.x,d.y=1/l.y,d.z=1/l.z,r.Matrix4.multiply(r.Matrix4.fromScale(d,A),h,h),f=r.Matrix4.clone(s),r.Matrix4.setTranslation(f,i.Cartesian3.ZERO,f),s=r.Matrix4.clone(s,new r.Matrix4);let u=r.Matrix4.fromTranslation(e,A),m=r.Matrix4.fromScale(l,I),x=r.Matrix4.multiply(u,m,A);r.Matrix4.multiply(s,x,s),r.Matrix4.multiply(f,x,f)}this.quantization=p,this.minimumHeight=o,this.maximumHeight=n,this.center=i.Cartesian3.clone(e),this.toScaledENU=h,this.fromScaledENU=s,this.matrix=f,this.hasVertexNormals=l,this.hasWebMercatorT=a.defaultValue(c,!1),this.hasGeodeticSurfaceNormals=a.defaultValue(d,!1),this.exaggeration=a.defaultValue(u,1),this.exaggerationRelativeHeight=a.defaultValue(m,0),this.stride=0,this._offsetGeodeticSurfaceNormal=0,this._offsetVertexNormal=0,this._calculateStrideAndOffsets()}V.prototype.encode=function(e,t,a,n,l,c,d,u){let m=n.x,h=n.y;if(this.quantization===_.BITS12){(a=r.Matrix4.multiplyByPoint(this.toScaledENU,a,E)).x=s.CesiumMath.clamp(a.x,0,1),a.y=s.CesiumMath.clamp(a.y,0,1),a.z=s.CesiumMath.clamp(a.z,0,1);let i=this.maximumHeight-this.minimumHeight,n=s.CesiumMath.clamp((l-this.minimumHeight)/i,0,1);r.Cartesian2.fromElements(a.x,a.y,w);let c=o.AttributeCompression.compressTextureCoordinates(w);r.Cartesian2.fromElements(a.z,n,w);let u=o.AttributeCompression.compressTextureCoordinates(w);r.Cartesian2.fromElements(m,h,w);let f=o.AttributeCompression.compressTextureCoordinates(w);if(e[t++]=c,e[t++]=u,e[t++]=f,this.hasWebMercatorT){r.Cartesian2.fromElements(d,0,w);let i=o.AttributeCompression.compressTextureCoordinates(w);e[t++]=i}}else i.Cartesian3.subtract(a,this.center,E),e[t++]=E.x,e[t++]=E.y,e[t++]=E.z,e[t++]=l,e[t++]=m,e[t++]=h,this.hasWebMercatorT&&(e[t++]=d);return this.hasVertexNormals&&(e[t++]=o.AttributeCompression.octPackFloat(c)),this.hasGeodeticSurfaceNormals&&(e[t++]=u.x,e[t++]=u.y,e[t++]=u.z),t};let q=new i.Cartesian3,G=new i.Cartesian3;V.prototype.addGeodeticSurfaceNormals=function(e,t,i){if(this.hasGeodeticSurfaceNormals)return;let a=this.stride,r=e.length/a;this.hasGeodeticSurfaceNormals=!0,this._calculateStrideAndOffsets();let o=this.stride;for(let n=0;n<r;n++){for(let i=0;i<a;i++){let r=n*a+i;t[n*o+i]=e[r]}let r=this.decodePosition(t,n,q),s=i.geodeticSurfaceNormal(r,G),l=n*o+this._offsetGeodeticSurfaceNormal;t[l]=s.x,t[l+1]=s.y,t[l+2]=s.z}},V.prototype.removeGeodeticSurfaceNormals=function(e,t){if(!this.hasGeodeticSurfaceNormals)return;let i=this.stride,a=e.length/i;this.hasGeodeticSurfaceNormals=!1,this._calculateStrideAndOffsets();let r=this.stride;for(let o=0;o<a;o++)for(let a=0;a<r;a++){let n=o*i+a;t[o*r+a]=e[n]}},V.prototype.decodePosition=function(e,t,n){if(a.defined(n)||(n=new i.Cartesian3),t*=this.stride,this.quantization===_.BITS12){let i=o.AttributeCompression.decompressTextureCoordinates(e[t],w);n.x=i.x,n.y=i.y;let a=o.AttributeCompression.decompressTextureCoordinates(e[t+1],w);return n.z=a.x,r.Matrix4.multiplyByPoint(this.fromScaledENU,n,n)}return n.x=e[t],n.y=e[t+1],n.z=e[t+2],i.Cartesian3.add(n,this.center,n)},V.prototype.getExaggeratedPosition=function(e,t,i){i=this.decodePosition(e,t,i);let a=this.exaggeration,r=this.exaggerationRelativeHeight;if(1!==a&&this.hasGeodeticSurfaceNormals){let o=this.decodeGeodeticSurfaceNormal(e,t,G),n=this.decodeHeight(e,t),s=P.getHeight(n,a,r)-n;i.x+=o.x*s,i.y+=o.y*s,i.z+=o.z*s}return i},V.prototype.decodeTextureCoordinates=function(e,t,i){return a.defined(i)||(i=new r.Cartesian2),t*=this.stride,this.quantization===_.BITS12?o.AttributeCompression.decompressTextureCoordinates(e[t+2],i):r.Cartesian2.fromElements(e[t+4],e[t+5],i)},V.prototype.decodeHeight=function(e,t){return(t*=this.stride,this.quantization===_.BITS12)?o.AttributeCompression.decompressTextureCoordinates(e[t+1],w).y*(this.maximumHeight-this.minimumHeight)+this.minimumHeight:e[t+3]},V.prototype.decodeWebMercatorT=function(e,t){return t*=this.stride,this.quantization===_.BITS12?o.AttributeCompression.decompressTextureCoordinates(e[t+3],w).x:e[t+6]},V.prototype.getOctEncodedNormal=function(e,t,i){let a=e[t=t*this.stride+this._offsetVertexNormal]/256,o=Math.floor(a);return r.Cartesian2.fromElements(o,256*(a-o),i)},V.prototype.decodeGeodeticSurfaceNormal=function(e,t,i){return t=t*this.stride+this._offsetGeodeticSurfaceNormal,i.x=e[t],i.y=e[t+1],i.z=e[t+2],i},V.prototype._calculateStrideAndOffsets=function(){let e=0;this.quantization===_.BITS12?e+=3:e+=6,this.hasWebMercatorT&&(e+=1),this.hasVertexNormals&&(this._offsetVertexNormal=e,e+=1),this.hasGeodeticSurfaceNormals&&(this._offsetGeodeticSurfaceNormal=e,e+=3),this.stride=e};let O={position3DAndHeight:0,textureCoordAndEncodedNormals:1,geodeticSurfaceNormal:2},B={compressed0:0,compressed1:1,geodeticSurfaceNormal:2};V.prototype.getAttributes=function(e){let t=n.ComponentDatatype.FLOAT,i=n.ComponentDatatype.getSizeInBytes(t),a=this.stride*i,r=0,o=[];function s(n,s){o.push({index:n,vertexBuffer:e,componentDatatype:t,componentsPerAttribute:s,offsetInBytes:r,strideInBytes:a}),r+=s*i}if(this.quantization===_.NONE){let e;s(O.position3DAndHeight,4),e=2+((this.hasWebMercatorT?1:0)+(this.hasVertexNormals?1:0)),s(O.textureCoordAndEncodedNormals,e),this.hasGeodeticSurfaceNormals&&s(O.geodeticSurfaceNormal,3)}else{let e=this.hasWebMercatorT||this.hasVertexNormals,t=this.hasWebMercatorT&&this.hasVertexNormals;s(B.compressed0,e?4:3),t&&s(B.compressed1,1),this.hasGeodeticSurfaceNormals&&s(B.geodeticSurfaceNormal,3)}return o},V.prototype.getAttributeLocations=function(){return this.quantization===_.NONE?O:B},V.clone=function(e,t){if(a.defined(e))return a.defined(t)||(t=new V),t.quantization=e.quantization,t.minimumHeight=e.minimumHeight,t.maximumHeight=e.maximumHeight,t.center=i.Cartesian3.clone(e.center),t.toScaledENU=r.Matrix4.clone(e.toScaledENU),t.fromScaledENU=r.Matrix4.clone(e.fromScaledENU),t.matrix=r.Matrix4.clone(e.matrix),t.hasVertexNormals=e.hasVertexNormals,t.hasWebMercatorT=e.hasWebMercatorT,t.hasGeodeticSurfaceNormals=e.hasGeodeticSurfaceNormals,t.exaggeration=e.exaggeration,t.exaggerationRelativeHeight=e.exaggerationRelativeHeight,t._calculateStrideAndOffsets(),t},e.EllipsoidalOccluder=l,e.TerrainEncoding=V});